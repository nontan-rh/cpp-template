name: Build CI Image

on:
  push:
    paths:
      - '.github/workflows/ci_image.yml'
      - 'docker/**.dockerfile'
      - 'script/build_docker_images.ps1'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy images (true/false)'
        required: true
        default: 'false'

jobs:
  Build:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Build
        run: |-
          set -euxo pipefail

          docker_tag="$(date '+%Y%m%d_%H%M')"
          git_tag="image_${docker_tag}"

          printenv DOCKER_REGISTRY_PASSWORD | docker login "$DOCKER_REGISTRY_HOST" --username "$DOCKER_REGISTRY_USERNAME" --password-stdin
          pwsh script/build_docker_images.ps1 -Registry "$DOCKER_REGISTRY_HOST/$GITHUB_REPOSITORY" -Tag "$docker_tag" "-Push:\$$INPUTS_DEPLOY"
          if [ "$INPUTS_DEPLOY" = "true" ]; then git tag "$git_tag"; git push origin "$git_tag"; fi
        shell: bash
        env:
          INPUTS_DEPLOY: ${{ github.event.inputs.deploy || 'false' }}
          DOCKER_REGISTRY_HOST: docker.pkg.github.com
          DOCKER_REGISTRY_USERNAME: ${{ github.actor }}
          DOCKER_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
